name: webiny-cms

vars:
  region: ${env.AWS_REGION}
  lumigo:
    token: ${env.LUMIGO_TOKEN}
  apiUrl: "https://d3sofjdc7z3qe9.cloudfront.net/graphql"

site:
  component: "@webiny/serverless-app"
  inputs:
    name: site-app
    description: Webiny Site
    region: ${vars.region}
    memory: 128
    timeout: 30
    root: ./site
    webpackConfig: ../webpack.config.js
    plugins:
      - factory: "@webiny/api-plugin-lumigo-tracer"
        options: ${vars.lumigo}
    env:
      SSR_FUNCTION: ${ssr.name}
      API_URL: ${vars.apiUrl}
ssr:
  component: "@webiny/serverless-function"
  inputs:
    name: site-ssr
    description: Site SSR
    region: ${vars.region}
    hook: yarn build:${cli.env}
    root: ./site
    code: ./site/build-ssr
    handler: handler.handler
    memory: 2048
    timeout: 30
    webpackConfig: ../webpack.config.js
    plugins:
      - factory: "@webiny/api-plugin-lumigo-tracer"
        options: ${vars.lumigo}

admin:
  component: "@webiny/serverless-app"
  inputs:
    name: admin-app
    region: ${vars.region}
    description: Webiny Admin
    hook: yarn build:${cli.env}
    root: ./admin
    webpackConfig: ../webpack.config.js
    plugins:
      - factory: "@webiny/api-plugin-lumigo-tracer"
        options: ${vars.lumigo}

api:
  component: "@webiny/serverless-api-gateway"
  inputs:
    name: Apps Gateway
    description: Serverless React Apps
    endpoints:
      - path: /admin/{key+}
        method: GET
        function: ${admin}
      - path: /admin
        method: GET
        function: ${admin}
      - path: /ssr/{key+}
        method: GET
        function: ${ssr}
      - path: /ssr
        method: GET
        function: ${ssr}
      - path: /{key+}
        method: GET
        function: ${site}
      - path: /
        method: GET
        function: ${site}

cdn:
  component: "@webiny/serverless-aws-cloudfront"
  inputs:
    origins:
      - url: ${api.url}
        pathPatterns:
          "/ssr":
            ttl: 0
            forward:
              headers: 'all'
              queryString: true
            allowedHttpMethods: ["GET", "HEAD", "OPTIONS", "PUT", "POST", "PATCH", "DELETE"]
